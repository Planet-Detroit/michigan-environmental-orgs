<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Data Admin - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1e293b;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #64748b;
            font-size: 14px;
        }

        .config {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .config h3 {
            margin-bottom: 10px;
            color: #f57c00;
        }

        .config input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .config button {
            background: #2f80c3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .config button:hover {
            background: #1e5a8a;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #14b8a6;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #14b8a6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0f766e;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #1e293b;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e1;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat {
            padding: 8px 16px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
        }

        .stat strong {
            color: #1e293b;
            margin-right: 5px;
        }

        .org-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .org-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 20px;
            transition: background 0.2s;
        }

        .org-item:hover {
            background: #f8fafc;
        }

        .org-item:last-child {
            border-bottom: none;
        }

        .org-item.editing {
            background: #fef3c7;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .org-id {
            font-size: 12px;
            color: #94a3b8;
            font-family: monospace;
        }

        .org-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .edit-indicator {
            color: #ea5a39;
            font-weight: 600;
            font-size: 14px;
        }

        .org-fields {
            display: grid;
            gap: 15px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-input, .field-textarea, .field-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .field-input:focus, .field-textarea:focus, .field-select:focus {
            outline: none;
            border-color: #14b8a6;
        }

        .field-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .field-select {
            cursor: pointer;
        }

        .tags-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tags-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 24px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .tag-remove {
            cursor: pointer;
            color: #0369a1;
            font-weight: bold;
            transition: color 0.2s;
        }

        .tag-remove:hover {
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            animation: slideIn 0.3s ease;
            font-weight: 600;
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        .toast.info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .disconnect-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .disconnect-btn:hover {
            background: #dc2626;
        }

        .no-tags {
            font-size: 13px;
            color: #94a3b8;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #1e293b;
        }

        /* Tab Styles */
        .tabs {
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            padding: 0 20px;
        }

        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #64748b;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #1e293b;
            background: #f8fafc;
        }

        .tab-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .bulk-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .bulk-section.highlight {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .bulk-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .bulk-select-all {
            margin-bottom: 10px;
            padding: 8px;
            background: #f0f9ff;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bulk-preview-item {
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
            align-items: start;
        }

        .bulk-preview-item input[type="checkbox"] {
            margin-top: 4px;
            cursor: pointer;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1>üåç Organization Data Admin Tool</h1>
                    <p class="subtitle">Search, edit, and manage organization data</p>
                </div>
                <button id="disconnectBtn" class="disconnect-btn hidden" onclick="disconnect()">
                    üîå Disconnect
                </button>
            </div>
        </header>

        <!-- Login/Config Section -->
        <div class="config" id="config-section">
            <h3>‚öôÔ∏è Setup Required</h3>
            <p style="margin-bottom: 15px;">Enter your Supabase credentials to get started:</p>
            <input type="text" id="supabase-url" placeholder="Supabase URL (e.g., https://xxx.supabase.co)">
            <input type="password" id="supabase-key" placeholder="Supabase Anon Key">
            <button onclick="connectSupabase()">Connect & Load Organizations</button>
        </div>

        <!-- Main Content (hidden until connected) -->
        <div id="main-content" class="hidden">
            <div class="controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-success" onclick="openCreateModal()">‚ûï Create New Organization</button>
                <button class="btn btn-primary" onclick="loadOrganizations()">üîÑ Refresh Data</button>
                <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectSupabase()">Disconnect</button>
            </div>

            <!-- Add New Categories Section (Available to all tabs) -->
            <div class="controls" style="margin-bottom: 20px; background: #f0fdf4; border-left: 4px solid #10b981;">
                <h3 style="margin-bottom: 15px; color: #1e293b;">‚ûï Add New Categories</h3>
                <div class="control-row">
                    <div style="flex: 1;">
                        <label class="field-label" style="margin-bottom: 5px; display: block;">New Focus Area</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newFocusInput" class="field-input" placeholder="e.g., Transportation" style="flex: 1;">
                            <button class="btn btn-success" onclick="addNewFocus()">Add Focus Area</button>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <label class="field-label" style="margin-bottom: 5px; display: block;">New Service Area</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newGeoInput" class="field-input" placeholder="e.g., Wayne County" style="flex: 1;">
                            <button class="btn btn-success" onclick="addNewGeo()">Add Service Area</button>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #047857; margin-top: 10px; font-weight: 500;">
                    üí° New categories will immediately appear in ALL tabs and dropdowns across the entire tool
                </p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('organizations')">
                        üìã Organizations
                    </button>
                    <button class="tab-button" onclick="switchTab('bulk')">
                        üîÑ Bulk Operations
                    </button>
                    <button class="tab-button" onclick="switchTab('quality')">
                        üîç Data Quality
                    </button>
                </div>
            </div>

            <!-- Organizations Tab -->
            <div id="organizations-tab" class="tab-content active">
            <div class="controls">
                <div class="control-row">
                    <select id="sortSelect" class="field-select" style="min-width: 150px;" onchange="handleSort()">
                        <option value="name">Sort: Name (A-Z)</option>
                        <option value="city">Sort: City (A-Z)</option>
                    </select>
                    <select id="focusFilter" class="field-select" style="min-width: 200px;" onchange="handleFocusFilter()">
                        <option value="">All Focus Areas</option>
                    </select>
                    <select id="cityFilter" class="field-select" style="min-width: 200px;" onchange="handleCityFilter()">
                        <option value="">All Cities</option>
                    </select>
                    <select id="geoFilter" class="field-select" style="min-width: 200px;" onchange="handleGeoFilter()">
                        <option value="">All Service Areas</option>
                    </select>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search by organization name..." oninput="handleSearch()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat">
                        <strong>Total:</strong>
                        <span id="totalCount">0</span>
                    </div>
                    <div class="stat">
                        <strong>Showing:</strong>
                        <span id="filteredCount">0</span>
                    </div>
                    <div class="stat">
                        <strong>Focus Areas:</strong>
                        <span id="focusCount">0</span>
                    </div>
                    <div class="stat">
                        <strong>Cities:</strong>
                        <span id="cityCount">0</span>
                    </div>
                    <div class="stat">
                        <strong>Service Areas:</strong>
                        <span id="geoCount">0</span>
                    </div>
                    <div class="stat" id="activeFilters" style="display: none; background: #fef3c7; color: #92400e;">
                        <strong>üîç</strong>
                        <span id="filterInfo">Filters active</span>
                    </div>
                </div>
            </div>

            <div class="org-list" id="orgList">
                <div class="empty-state">
                    <div class="empty-icon">‚è≥</div>
                    <h3>Loading organizations...</h3>
                </div>
            </div>
            </div>
            <!-- End Organizations Tab -->

            <!-- Bulk Operations Tab -->
            <div id="bulk-tab" class="tab-content">
                <div class="bulk-section highlight">
                    <h3 style="margin-bottom: 15px; color: #1e293b;">üîÑ Bulk Assign Categories</h3>
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">
                        Search for organizations by keyword or city, preview matches, then bulk assign focus areas or service areas.
                    </p>
                    
                    <!-- Search Filters -->
                    <div class="bulk-filters">
                        <div>
                            <label class="field-label">Search organizations containing:</label>
                            <input type="text" id="bulkSearchInput" class="field-input" placeholder='e.g., "lake association" or "watershed"'>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Searches in name and mission statement</p>
                        </div>
                        <div>
                            <label class="field-label">Filter by city (optional):</label>
                            <select id="bulkCityFilter" class="field-select">
                                <option value="">All cities</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="previewBulkAssign()">üîç Preview Matches</button>

                    <!-- Results Section -->
                    <div id="bulkResults" style="margin-top: 20px; display: none;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <span id="bulkMatchCount" style="font-weight: bold; color: #1e40af;"></span>
                        </div>

                        <!-- Assignment Options -->
                        <div class="bulk-filters" style="margin-bottom: 15px;">
                            <div>
                                <label class="field-label">Assign Focus Area:</label>
                                <select id="bulkFocusSelect" class="field-select" onchange="toggleBulkCustomFocus()">
                                    <option value="">Select existing...</option>
                                    <option value="__custom__">+ Create New Focus Area</option>
                                </select>
                                <input type="text" id="bulkCustomFocus" class="field-input" placeholder="Enter new focus area name..." style="margin-top: 8px; display: none;">
                            </div>
                            <div>
                                <label class="field-label">Assign Service Area:</label>
                                <select id="bulkGeoSelect" class="field-select" onchange="toggleBulkCustomGeo()">
                                    <option value="">Select existing...</option>
                                    <option value="__custom__">+ Create New Service Area</option>
                                </select>
                                <input type="text" id="bulkCustomGeo" class="field-input" placeholder="Enter new service area name..." style="margin-top: 8px; display: none;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-success" onclick="executeBulkAssign('focus')" id="bulkExecuteFocusBtn">
                                ‚úÖ Assign Focus Area to Selected
                            </button>
                            <button class="btn btn-success" onclick="executeBulkAssign('geo_location')" id="bulkExecuteGeoBtn">
                                ‚úÖ Assign Service Area to Selected
                            </button>
                        </div>

                        <!-- Preview List -->
                        <div id="bulkPreviewList" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <p style="font-size: 12px; color: #92400e; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px;">
                        ‚ö†Ô∏è <strong>Preview before applying!</strong> Uncheck any organizations you want to exclude.
                    </p>
                </div>
            </div>
            <!-- End Bulk Tab -->

            <!-- Data Quality Tab -->
            <div id="quality-tab" class="tab-content">
                <div class="bulk-section highlight">
                    <h3 style="margin-bottom: 15px; color: #1e293b;">üîç Find & Fix Missing Data</h3>
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">
                        Identify organizations missing focus areas or service areas, then classify them in bulk.
                    </p>

                    <!-- Filter Options -->
                    <div class="bulk-filters" style="margin-bottom: 20px;">
                        <div>
                            <label class="field-label">Search by name (optional):</label>
                            <input type="text" id="qualitySearchInput" class="field-input" placeholder='e.g., "lake" or "watershed"' oninput="updateQualityView()">
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Partial match on organization name</p>
                        </div>
                        <div>
                            <label class="field-label">Show organizations missing:</label>
                            <select id="qualityFilter" class="field-select" onchange="updateQualityView()">
                                <option value="both">Both Focus & Service Areas</option>
                                <option value="focus">Focus Areas only</option>
                                <option value="service">Service Areas only</option>
                                <option value="either">Either Focus or Service Areas</option>
                            </select>
                        </div>
                        <div>
                            <label class="field-label">Filter by city (optional):</label>
                            <select id="qualityCityFilter" class="field-select" onchange="updateQualityView()">
                                <option value="">All cities</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="loadQualityView()">üîç Find Missing Data</button>

                    <!-- Results Section -->
                    <div id="qualityResults" style="margin-top: 20px; display: none;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <span id="qualityMatchCount" style="font-weight: bold; color: #1e40af;"></span>
                        </div>

                        <!-- Assignment Options -->
                        <div class="bulk-filters" style="margin-bottom: 15px;">
                            <div>
                                <label class="field-label">Assign Focus Area to selected:</label>
                                <select id="qualityFocusSelect" class="field-select" onchange="toggleQualityCustomFocus()">
                                    <option value="">Select existing...</option>
                                    <option value="__custom__">+ Create New Focus Area</option>
                                </select>
                                <input type="text" id="qualityCustomFocus" class="field-input" placeholder="Enter new focus area name..." style="margin-top: 8px; display: none;">
                            </div>
                            <div>
                                <label class="field-label">Assign Service Area to selected:</label>
                                <select id="qualityGeoSelect" class="field-select" onchange="toggleQualityCustomGeo()">
                                    <option value="">Select existing...</option>
                                    <option value="__custom__">+ Create New Service Area</option>
                                </select>
                                <input type="text" id="qualityCustomGeo" class="field-input" placeholder="Enter new service area name..." style="margin-top: 8px; display: none;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-success" onclick="executeQualityAssign('focus')">
                                ‚úÖ Assign Focus Area to Selected
                            </button>
                            <button class="btn btn-success" onclick="executeQualityAssign('geo_location')">
                                ‚úÖ Assign Service Area to Selected
                            </button>
                        </div>

                        <!-- Preview List -->
                        <div id="qualityPreviewList" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <p style="font-size: 12px; color: #92400e; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px;">
                        üí° <strong>Tip:</strong> Use this to clean up your data and ensure all organizations are properly categorized.
                    </p>
                </div>
            </div>
            <!-- End Data Quality Tab -->

        </div>

        <!-- Create Organization Modal -->
        <div id="createModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Organization</h2>
                    <button class="modal-close" onclick="closeCreateModal()">√ó</button>
                </div>
                <form id="createForm" onsubmit="createOrganization(event)">
                    <div class="form-row">
                        <label class="field-label">Organization Name *</label>
                        <input type="text" id="createName" class="field-input" required>
                    </div>
                    <div class="form-row">
                        <label class="field-label">City/Region</label>
                        <select id="createCity" class="field-select">
                            <option value="">Select a city...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="field-label">URL</label>
                        <input type="url" id="createUrl" class="field-input" placeholder="https://">
                    </div>
                    <div class="form-row">
                        <label class="field-label">Mission Statement</label>
                        <textarea id="createMission" class="field-textarea" rows="4"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="field-label">Service Areas</label>
                        <div id="createGeoTags" class="tags-list" style="margin-bottom: 10px;"></div>
                        <select id="createGeoSelect" class="field-select" onchange="addCreateTag('geo')">
                            <option value="">+ Add service area...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="field-label">Focus Areas</label>
                        <div id="createFocusTags" class="tags-list" style="margin-bottom: 10px;"></div>
                        <select id="createFocusSelect" class="field-select" onchange="addCreateTag('focus')">
                            <option value="">+ Add focus area...</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeCreateModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">Create Organization</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        console.log('üéâ Admin tool v2.0 - Script loaded successfully!');
        
        let supabaseClient = null;
        let organizations = [];
        let filteredOrgs = [];
        let editingOrgs = new Set();
        let allFocusAreas = [];
        let allCities = [];
        let allGeoLocations = [];
        let selectedFocusFilter = '';
        let selectedCityFilter = '';
        let selectedGeoFilter = '';
        let currentSort = 'name';
        let bulkMatches = [];

        // Initialize - check for saved credentials
        document.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('supabase_url');
            const savedKey = localStorage.getItem('supabase_key');

            if (savedUrl && savedKey) {
                document.getElementById('supabase-url').value = savedUrl;
                document.getElementById('supabase-key').value = savedKey;
                connectSupabase();
            }

            document.getElementById('searchInput').addEventListener('input', handleSearch);
        });

        function connectSupabase() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();

            if (!url || !key) {
                alert('Please enter both Supabase URL and key');
                return;
            }

            try {
                supabaseClient = window.supabase.createClient(url, key);

                // Save credentials
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);

                // Hide config, show main content
                document.getElementById('config-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');

                loadOrganizations();
            } catch (error) {
                alert('Error connecting to Supabase: ' + error.message);
            }
        }

        function disconnectSupabase() {
            if (!confirm('Disconnect from Supabase?\n\nYour credentials will be cleared.')) {
                return;
            }

            localStorage.removeItem('supabase_url');
            localStorage.removeItem('supabase_key');

            supabaseClient = null;
            organizations = [];
            filteredOrgs = [];
            allFocusAreas = [];
            allCities = [];
            allGeoLocations = [];
            selectedFocusFilter = '';
            selectedCityFilter = '';
            selectedGeoFilter = '';
            currentSort = 'name';

            document.getElementById('config-section').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('supabase-url').value = '';
            document.getElementById('supabase-key').value = '';
        }

        async function loadOrganizations() {
            try {
                showToast('Loading organizations...', 'info');

                const { data, error } = await supabaseClient
                    .from('organizations')
                    .select('id, name, slug, mission_statement_text, url, focus, city, geo_location')
                    .eq('status', 'approved')
                    .order(currentSort);

                if (error) throw error;

                organizations = data || [];
                filteredOrgs = [...organizations];

                // Extract all unique focus areas, cities, and geo_locations
                const focusSet = new Set();
                const citySet = new Set();
                const geoLocationSet = new Set();
                organizations.forEach(org => {
                    let focusArray = parseFocusArray(org.focus);
                    focusArray.forEach(focus => {
                        if (focus && focus.trim()) {
                            focusSet.add(focus.trim());
                        }
                    });
                    if (org.city && org.city.trim()) {
                        citySet.add(org.city.trim());
                    }
                    let geoArray = parseFocusArray(org.geo_location); // Use same parser for arrays
                    geoArray.forEach(geo => {
                        if (geo && geo.trim()) {
                            geoLocationSet.add(geo.trim());
                        }
                    });
                });
                allFocusAreas = Array.from(focusSet).sort();
                allCities = Array.from(citySet).sort();
                allGeoLocations = Array.from(geoLocationSet).sort();

                // Populate focus filter dropdown
                const focusFilterDropdown = document.getElementById('focusFilter');
                focusFilterDropdown.innerHTML = '<option value="">All Focus Areas</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    focusFilterDropdown.appendChild(option);
                });

                // Populate city filter dropdown
                const cityFilterDropdown = document.getElementById('cityFilter');
                cityFilterDropdown.innerHTML = '<option value="">All Cities</option>';
                allCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    cityFilterDropdown.appendChild(option);
                });

                // Populate geo_location filter dropdown
                const geoFilterDropdown = document.getElementById('geoFilter');
                geoFilterDropdown.innerHTML = '<option value="">All Service Areas</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    geoFilterDropdown.appendChild(option);
                });

                updateStats();
                renderOrganizations();
                
                // Populate bulk assign dropdowns
                const bulkFocusSelect = document.getElementById('bulkFocusSelect');
                bulkFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    bulkFocusSelect.appendChild(option);
                });

                const bulkGeoSelect = document.getElementById('bulkGeoSelect');
                bulkGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    bulkGeoSelect.appendChild(option);
                });

                const bulkCityFilter = document.getElementById('bulkCityFilter');
                bulkCityFilter.innerHTML = '<option value="">All cities</option>';
                allCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    bulkCityFilter.appendChild(option);
                });

                // Populate Quality tab dropdowns
                const qualityFocusSelect = document.getElementById('qualityFocusSelect');
                qualityFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    qualityFocusSelect.appendChild(option);
                });

                const qualityGeoSelect = document.getElementById('qualityGeoSelect');
                qualityGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    qualityGeoSelect.appendChild(option);
                });

                const qualityCityFilter = document.getElementById('qualityCityFilter');
                qualityCityFilter.innerHTML = '<option value="">All cities</option>';
                allCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    qualityCityFilter.appendChild(option);
                });
                
                showToast(`‚úÖ Loaded ${organizations.length} organizations with ${allFocusAreas.length} focus areas`, 'success');
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load organizations: ' + error.message, 'error');
            }
        }

        function parseFocusArray(focus) {
            try {
                if (Array.isArray(focus)) {
                    return focus;
                } else if (focus && typeof focus === 'string' && focus.startsWith('[')) {
                    return JSON.parse(focus.replace(/'/g, '"'));
                } else if (focus) {
                    return [focus];
                }
            } catch (e) {
                console.error('Focus parse error:', e, focus);
                return focus ? [focus] : [];
            }
            return [];
        }

        function handleSearch() {
            applyFilters();
        }

        function handleFocusFilter() {
            selectedFocusFilter = document.getElementById('focusFilter').value;
            applyFilters();
        }

        function handleCityFilter() {
            selectedCityFilter = document.getElementById('cityFilter').value;
            applyFilters();
        }

        function handleGeoFilter() {
            selectedGeoFilter = document.getElementById('geoFilter').value;
            applyFilters();
        }

        function handleSort() {
            currentSort = document.getElementById('sortSelect').value;
            loadOrganizations();
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            filteredOrgs = organizations.filter(org => {
                // Search filter
                const matchesSearch = !searchQuery || (org.name && org.name.toLowerCase().includes(searchQuery));
                
                // Focus filter
                let matchesFocus = true;
                if (selectedFocusFilter) {
                    const focusArray = parseFocusArray(org.focus);
                    matchesFocus = focusArray.includes(selectedFocusFilter);
                }
                
                // City filter
                let matchesCity = true;
                if (selectedCityFilter) {
                    matchesCity = org.city === selectedCityFilter;
                }
                
                // Geo location filter
                let matchesGeo = true;
                if (selectedGeoFilter) {
                    const geoArray = parseFocusArray(org.geo_location);
                    matchesGeo = geoArray.includes(selectedGeoFilter);
                }
                
                return matchesSearch && matchesFocus && matchesCity && matchesGeo;
            });
            
            updateStats();
            renderOrganizations();
        }

        function renderOrganizations() {
            const container = document.getElementById('orgList');

            if (filteredOrgs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h3>No organizations found</h3>
                        <p>Try adjusting your search</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredOrgs.map(org => {
                const isEditing = editingOrgs.has(org.id);
                const focusArray = parseFocusArray(org.focus);
                const geoArray = parseFocusArray(org.geo_location);
                
                // Get available focus areas and geo_locations (all minus the ones already selected)
                const availableFocusAreas = allFocusAreas.filter(f => !focusArray.includes(f));
                const availableGeoLocations = allGeoLocations.filter(g => !geoArray.includes(g));

                return `
                    <div class="org-item ${isEditing ? 'editing' : ''}" data-id="${org.id}">
                        <div class="org-header">
                            <div>
                                <div class="org-name">${escapeHtml(org.name || 'Unnamed Organization')}</div>
                                <div class="org-id">${org.id}</div>
                            </div>
                            <div class="org-actions">
                                ${isEditing ? '<span class="edit-indicator">‚óè Saving...</span>' : ''}
                                <button class="btn btn-danger btn-small" onclick="deleteOrg('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        <div class="org-fields">
                            <div class="field">
                                <label class="field-label">Organization Name</label>
                                <input
                                    type="text"
                                    class="field-input"
                                    value="${escapeHtml(org.name || '')}"
                                    onchange="updateField('${org.id}', 'name', this.value)"
                                >
                            </div>
                            <div class="field">
                                <label class="field-label">City/Region</label>
                                <select class="field-select" onchange="updateField('${org.id}', 'city', this.value)">
                                    <option value="">No city selected</option>
                                    ${allCities.map(city => `
                                        <option value="${escapeHtml(city)}" ${org.city === city ? 'selected' : ''}>${escapeHtml(city)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="field">
                                <label class="field-label">URL</label>
                                <input
                                    type="text"
                                    class="field-input"
                                    value="${escapeHtml(org.url || '')}"
                                    onchange="updateField('${org.id}', 'url', this.value)"
                                >
                            </div>
                            <div class="field">
                                <label class="field-label">Mission Statement</label>
                                <textarea
                                    class="field-textarea"
                                    onchange="updateField('${org.id}', 'mission_statement_text', this.value)"
                                >${escapeHtml(org.mission_statement_text || '')}</textarea>
                            </div>
                            <div class="field">
                                <label class="field-label">Focus Areas</label>
                                <div class="tags-container">
                                    <div class="tags-list">
                                        ${focusArray.length > 0 ? focusArray.map(tag => `
                                            <span class="tag">
                                                ${escapeHtml(tag)}
                                                <span class="tag-remove" onclick="removeTag('${org.id}', 'focus', '${escapeHtml(tag).replace(/'/g, "\\'")}')">√ó</span>
                                            </span>
                                        `).join('') : '<span class="no-tags">No focus areas selected</span>'}
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <input 
                                            type="text" 
                                            id="customFocus_${org.id}"
                                            class="field-input" 
                                            placeholder="Type new focus area..." 
                                            style="flex: 1;"
                                            onkeypress="if(event.key==='Enter'){addCustomTag('${org.id}', 'focus', this.value); this.value='';}"
                                        >
                                        <button 
                                            class="btn btn-success btn-small" 
                                            onclick="const input = document.getElementById('customFocus_${org.id}'); addCustomTag('${org.id}', 'focus', input.value); input.value='';"
                                            style="white-space: nowrap;"
                                        >+ Add Custom</button>
                                    </div>
                                    ${availableFocusAreas.length > 0 ? `
                                        <select class="field-select" style="margin-top: 10px;" onchange="addTag('${org.id}', 'focus', this.value); this.value = '';">
                                            <option value="">Or select existing...</option>
                                            ${availableFocusAreas.map(focus => `
                                                <option value="${escapeHtml(focus)}">${escapeHtml(focus)}</option>
                                            `).join('')}
                                        </select>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="field">
                                <label class="field-label">Service Area / Geographic Location</label>
                                <div class="tags-container">
                                    <div class="tags-list">
                                        ${geoArray.length > 0 ? geoArray.map(tag => `
                                            <span class="tag" style="background: #dbeafe; color: #1e40af;">
                                                ${escapeHtml(tag)}
                                                <span class="tag-remove" onclick="removeTag('${org.id}', 'geo_location', '${escapeHtml(tag).replace(/'/g, "\\'")}')">√ó</span>
                                            </span>
                                        `).join('') : '<span class="no-tags">No service areas selected</span>'}
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <input 
                                            type="text" 
                                            id="customGeo_${org.id}"
                                            class="field-input" 
                                            placeholder="Type new service area..." 
                                            style="flex: 1;"
                                            onkeypress="if(event.key==='Enter'){addCustomTag('${org.id}', 'geo_location', this.value); this.value='';}"
                                        >
                                        <button 
                                            class="btn btn-success btn-small" 
                                            onclick="const input = document.getElementById('customGeo_${org.id}'); addCustomTag('${org.id}', 'geo_location', input.value); input.value='';"
                                            style="white-space: nowrap;"
                                        >+ Add Custom</button>
                                    </div>
                                    ${availableGeoLocations.length > 0 ? `
                                        <select class="field-select" style="margin-top: 10px;" onchange="addTag('${org.id}', 'geo_location', this.value); this.value = '';">
                                            <option value="">Or select existing...</option>
                                            ${availableGeoLocations.map(geo => `
                                                <option value="${escapeHtml(geo)}">${escapeHtml(geo)}</option>
                                            `).join('')}
                                        </select>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateField(id, field, value) {
            try {
                editingOrgs.add(id);
                renderOrganizations();

                const { error } = await supabaseClient
                    .from('organizations')
                    .update({ [field]: value })
                    .eq('id', id);

                if (error) throw error;

                // Update local data
                const org = organizations.find(o => o.id === id);
                if (org) {
                    org[field] = value;
                }

                editingOrgs.delete(id);
                renderOrganizations();
                showToast('‚úÖ Saved!', 'success');
            } catch (error) {
                console.error('Update error:', error);
                editingOrgs.delete(id);
                renderOrganizations();
                showToast('Failed to save: ' + error.message, 'error');
            }
        }

        async function addTag(orgId, field, tag) {
            if (!tag) return;

            const org = organizations.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);

            if (!array.includes(tag)) {
                array.push(tag);
                await updateField(orgId, field, array);
            }
        }

        async function addCustomTag(orgId, field, tag) {
            tag = tag.trim();
            
            if (!tag) {
                showToast('Please enter a value', 'error');
                return;
            }

            const org = organizations.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);

            if (array.includes(tag)) {
                showToast(`"${tag}" is already added to this organization`, 'error');
                return;
            }

            // Add to organization
            array.push(tag);
            await updateField(orgId, field, array);

            // Add to global lists if not already there
            if (field === 'focus' && !allFocusAreas.includes(tag)) {
                allFocusAreas.push(tag);
                allFocusAreas.sort();
                
                // Update focus filter dropdown
                const focusFilterDropdown = document.getElementById('focusFilter');
                focusFilterDropdown.innerHTML = '<option value="">All Focus Areas</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    focusFilterDropdown.appendChild(option);
                });
                
                // Update bulk assign dropdown too
                const bulkFocusSelect = document.getElementById('bulkFocusSelect');
                bulkFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    bulkFocusSelect.appendChild(option);
                });

                // Update quality dropdown too
                const qualityFocusSelect = document.getElementById('qualityFocusSelect');
                qualityFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
                allFocusAreas.forEach(focus => {
                    const option = document.createElement('option');
                    option.value = focus;
                    option.textContent = focus;
                    qualityFocusSelect.appendChild(option);
                });
                
                showToast(`‚úÖ Added "${tag}" to organization and global focus areas list!`, 'success');
            } else if (field === 'geo_location' && !allGeoLocations.includes(tag)) {
                allGeoLocations.push(tag);
                allGeoLocations.sort();
                
                // Update geo filter dropdown
                const geoFilterDropdown = document.getElementById('geoFilter');
                geoFilterDropdown.innerHTML = '<option value="">All Service Areas</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    geoFilterDropdown.appendChild(option);
                });

                // Update bulk geo select too
                const bulkGeoSelect = document.getElementById('bulkGeoSelect');
                bulkGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    bulkGeoSelect.appendChild(option);
                });

                // Update quality geo select too
                const qualityGeoSelect = document.getElementById('qualityGeoSelect');
                qualityGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
                allGeoLocations.forEach(geo => {
                    const option = document.createElement('option');
                    option.value = geo;
                    option.textContent = geo;
                    qualityGeoSelect.appendChild(option);
                });
                
                showToast(`‚úÖ Added "${tag}" to organization and global service areas list!`, 'success');
            } else {
                showToast(`‚úÖ Added "${tag}" to organization!`, 'success');
            }
            
            updateStats();
            
            // Re-render organizations so all dropdowns update with the new value
            renderOrganizations();
        }

        async function removeTag(orgId, field, tag) {
            const org = organizations.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);
            array = array.filter(t => t !== tag);
            await updateField(orgId, field, array);
        }

        async function deleteOrg(id, name) {
            try {
                editingOrgs.add(id);
                renderOrganizations();

                const { error } = await supabaseClient
                    .from('organizations')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Remove from local data
                organizations = organizations.filter(org => org.id !== id);
                filteredOrgs = filteredOrgs.filter(org => org.id !== id);
                
                // Remove from bulk/quality matches if present
                bulkMatches = bulkMatches.filter(org => org.id !== id);
                qualityMatches = qualityMatches.filter(org => org.id !== id);
                
                editingOrgs.delete(id);

                updateStats();
                renderOrganizations();
                showToast(`üóëÔ∏è Deleted "${name}"`, 'success');
            } catch (error) {
                console.error('Delete error:', error);
                editingOrgs.delete(id);
                renderOrganizations();
                showToast('Failed to delete: ' + error.message, 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = organizations.length;
            document.getElementById('filteredCount').textContent = filteredOrgs.length;
            document.getElementById('focusCount').textContent = allFocusAreas.length;
            document.getElementById('cityCount').textContent = allCities.length;
            document.getElementById('geoCount').textContent = allGeoLocations.length;
            
            // Show/hide active filters indicator
            const searchQuery = document.getElementById('searchInput').value;
            const hasFilters = selectedFocusFilter || selectedCityFilter || selectedGeoFilter || searchQuery;
            const activeFiltersEl = document.getElementById('activeFilters');
            
            if (hasFilters) {
                activeFiltersEl.style.display = 'block';
                const filters = [];
                if (selectedFocusFilter) filters.push(`Focus: ${selectedFocusFilter}`);
                if (selectedCityFilter) filters.push(`City: ${selectedCityFilter}`);
                if (selectedGeoFilter) filters.push(`Service Area: ${selectedGeoFilter}`);
                if (searchQuery) filters.push(`Search: "${searchQuery}"`);
                document.getElementById('filterInfo').textContent = filters.join(' ‚Ä¢ ');
            } else {
                activeFiltersEl.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create Organization Modal Functions
        let createGeoTags = [];
        let createFocusTags = [];

        function addNewFocus() {
            const input = document.getElementById('newFocusInput');
            const newFocus = input.value.trim();
            
            if (!newFocus) {
                showToast('Please enter a focus area name', 'error');
                return;
            }
            
            if (allFocusAreas.includes(newFocus)) {
                showToast('This focus area already exists', 'error');
                return;
            }
            
            // Add to the list
            allFocusAreas.push(newFocus);
            allFocusAreas.sort();
            
            // Refresh the focus filter dropdown
            const focusFilterDropdown = document.getElementById('focusFilter');
            focusFilterDropdown.innerHTML = '<option value="">All Focus Areas</option>';
            allFocusAreas.forEach(focus => {
                const option = document.createElement('option');
                option.value = focus;
                option.textContent = focus;
                focusFilterDropdown.appendChild(option);
            });
            
            // Update bulk assign dropdown too
            const bulkFocusSelect = document.getElementById('bulkFocusSelect');
            bulkFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
            allFocusAreas.forEach(focus => {
                const option = document.createElement('option');
                option.value = focus;
                option.textContent = focus;
                bulkFocusSelect.appendChild(option);
            });

            // Update quality dropdown too
            const qualityFocusSelect = document.getElementById('qualityFocusSelect');
            qualityFocusSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Focus Area</option>';
            allFocusAreas.forEach(focus => {
                const option = document.createElement('option');
                option.value = focus;
                option.textContent = focus;
                qualityFocusSelect.appendChild(option);
            });
            
            updateStats();
            renderOrganizations(); // Re-render so new value appears in all org dropdowns
            input.value = '';
            showToast(`‚úÖ Added "${newFocus}" - now available in all dropdowns!`, 'success');
        }

        function addNewGeo() {
            const input = document.getElementById('newGeoInput');
            const newGeo = input.value.trim();
            
            if (!newGeo) {
                showToast('Please enter a service area name', 'error');
                return;
            }
            
            if (allGeoLocations.includes(newGeo)) {
                showToast('This service area already exists', 'error');
                return;
            }
            
            // Add to the list
            allGeoLocations.push(newGeo);
            allGeoLocations.sort();
            
            // Refresh the geo filter dropdown
            const geoFilterDropdown = document.getElementById('geoFilter');
            geoFilterDropdown.innerHTML = '<option value="">All Service Areas</option>';
            allGeoLocations.forEach(geo => {
                const option = document.createElement('option');
                option.value = geo;
                option.textContent = geo;
                geoFilterDropdown.appendChild(option);
            });

            // Update bulk geo select too
            const bulkGeoSelect = document.getElementById('bulkGeoSelect');
            bulkGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
            allGeoLocations.forEach(geo => {
                const option = document.createElement('option');
                option.value = geo;
                option.textContent = geo;
                bulkGeoSelect.appendChild(option);
            });

            // Update quality geo select too
            const qualityGeoSelect = document.getElementById('qualityGeoSelect');
            qualityGeoSelect.innerHTML = '<option value="">Select existing...</option><option value="__custom__">+ Create New Service Area</option>';
            allGeoLocations.forEach(geo => {
                const option = document.createElement('option');
                option.value = geo;
                option.textContent = geo;
                qualityGeoSelect.appendChild(option);
            });

            // Update bulk city filter
            const bulkCityFilter = document.getElementById('bulkCityFilter');
            if (allCities.length > 0) {
                bulkCityFilter.innerHTML = '<option value="">All cities</option>';
                allCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    bulkCityFilter.appendChild(option);
                });
            }

            // Update quality city filter too
            const qualityCityFilter = document.getElementById('qualityCityFilter');
            if (allCities.length > 0) {
                qualityCityFilter.innerHTML = '<option value="">All cities</option>';
                allCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    qualityCityFilter.appendChild(option);
                });
            }
            
            updateStats();
            renderOrganizations(); // Re-render so new value appears in all org dropdowns
            input.value = '';
            showToast(`‚úÖ Added "${newGeo}" - now available in all dropdowns!`, 'success');
        }

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        function previewBulkAssign() {
            const searchTerm = document.getElementById('bulkSearchInput').value.trim().toLowerCase();
            const cityFilter = document.getElementById('bulkCityFilter').value;
            
            if (!searchTerm && !cityFilter) {
                showToast('Please enter a search term or select a city', 'error');
                return;
            }
            
            // Find matching organizations
            bulkMatches = organizations.filter(org => {
                const nameMatch = !searchTerm || org.name?.toLowerCase().includes(searchTerm);
                const missionMatch = !searchTerm || org.mission_statement_text?.toLowerCase().includes(searchTerm);
                const cityMatch = !cityFilter || org.city === cityFilter;
                
                return (nameMatch || missionMatch) && cityMatch;
            });
            
            // Display preview
            const resultsDiv = document.getElementById('bulkResults');
            const previewList = document.getElementById('bulkPreviewList');
            const matchCount = document.getElementById('bulkMatchCount');
            
            if (bulkMatches.length === 0) {
                matchCount.textContent = '‚ùå No matches found';
                resultsDiv.style.display = 'block';
                previewList.innerHTML = '';
                return;
            }
            
            matchCount.textContent = `‚úÖ Found ${bulkMatches.length} matching organizations`;
            
            previewList.innerHTML = `
                <div class="bulk-select-all">
                    <input type="checkbox" id="bulkSelectAll" checked onchange="toggleAllBulkMatches(this.checked)" style="cursor: pointer;">
                    <label for="bulkSelectAll" style="cursor: pointer; font-weight: bold; color: #1e40af;">Select/Deselect All</label>
                </div>
            ` + bulkMatches.map((org, index) => {
                const focusArray = parseFocusArray(org.focus);
                const geoArray = parseFocusArray(org.geo_location);
                return `
                    <div class="bulk-preview-item">
                        <input type="checkbox" class="bulk-checkbox" data-org-id="${org.id}" checked>
                        <div style="flex: 1;">
                            <strong>${escapeHtml(org.name)}</strong>
                            ${org.city ? `<span style="color: #64748b; font-size: 12px;"> ‚Ä¢ ${escapeHtml(org.city)}</span>` : ''}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                Focus: ${focusArray.length > 0 ? focusArray.join(', ') : 'None'}<br>
                                Service Areas: ${geoArray.length > 0 ? geoArray.join(', ') : 'None'}
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteFromBulk('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
            
            resultsDiv.style.display = 'block';
        }

        function toggleAllBulkMatches(checked) {
            document.querySelectorAll('.bulk-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        async function deleteFromBulk(id, name) {
            await deleteOrg(id, name);
            // Refresh the bulk view
            previewBulkAssign();
        }

        async function executeBulkAssign(field) {
            // Get value from dropdown or custom input
            let value;
            if (field === 'focus') {
                const dropdown = document.getElementById('bulkFocusSelect').value;
                value = dropdown === '__custom__' 
                    ? document.getElementById('bulkCustomFocus').value.trim()
                    : dropdown;
            } else {
                const dropdown = document.getElementById('bulkGeoSelect').value;
                value = dropdown === '__custom__' 
                    ? document.getElementById('bulkCustomGeo').value.trim()
                    : dropdown;
            }

            const fieldName = field === 'focus' ? 'focus area' : 'service area';

            if (!value) {
                showToast(`Please ${value === '__custom__' ? 'enter' : 'select'} a ${fieldName} to assign`, 'error');
                return;
            }

            const checkedIds = Array.from(document.querySelectorAll('.bulk-checkbox:checked'))
                .map(cb => cb.dataset.orgId);

            const selectedOrgs = bulkMatches.filter(org => checkedIds.includes(org.id));

            if (selectedOrgs.length === 0) {
                showToast('No organizations selected', 'error');
                return;
            }

            const confirmed = confirm(`Add "${value}" to ${selectedOrgs.length} selected organizations?`);
            if (!confirmed) return;

            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;

            for (const org of selectedOrgs) {
                let array = parseFocusArray(org[field]);

                if (array.includes(value)) {
                    skipCount++;
                    continue;
                }

                array.push(value);

                try {
                    const { error } = await supabaseClient
                        .from('organizations')
                        .update({ [field]: array })
                        .eq('id', org.id);

                    if (error) {
                        console.error(`Failed to update ${org.name}:`, error);
                        errorCount++;
                        continue;
                    }

                    org[field] = array;
                    successCount++;
                } catch (error) {
                    console.error(`Failed to update ${org.name}:`, error);
                    errorCount++;
                }
            }

            if (errorCount > 0) {
                showToast(`‚ö†Ô∏è Added to ${successCount} orgs, ${skipCount} already had it, ${errorCount} failed`, 'error');
            } else {
                showToast(`‚úÖ Added "${value}" to ${successCount} organizations (${skipCount} already had it)`, 'success');
            }

            // Reset
            bulkMatches = [];
            document.getElementById('bulkResults').style.display = 'none';
            document.getElementById('bulkSearchInput').value = '';
            document.getElementById('bulkCityFilter').value = '';
            document.getElementById('bulkFocusSelect').value = '';
            document.getElementById('bulkGeoSelect').value = '';
            document.getElementById('bulkCustomFocus').style.display = 'none';
            document.getElementById('bulkCustomGeo').style.display = 'none';
            
            loadOrganizations();
        }

        function toggleBulkCustomFocus() {
            const select = document.getElementById('bulkFocusSelect');
            const input = document.getElementById('bulkCustomFocus');
            input.style.display = select.value === '__custom__' ? 'block' : 'none';
            if (select.value === '__custom__') {
                input.focus();
            }
        }

        function toggleBulkCustomGeo() {
            const select = document.getElementById('bulkGeoSelect');
            const input = document.getElementById('bulkCustomGeo');
            input.style.display = select.value === '__custom__' ? 'block' : 'none';
            if (select.value === '__custom__') {
                input.focus();
            }
        }

        // Data Quality Functions
        let qualityMatches = [];

        function loadQualityView() {
            updateQualityView();
        }

        function updateQualityView() {
            const filter = document.getElementById('qualityFilter').value;
            const cityFilter = document.getElementById('qualityCityFilter').value;
            const searchTerm = document.getElementById('qualitySearchInput').value.trim().toLowerCase();

            // Find organizations with missing data
            qualityMatches = organizations.filter(org => {
                const focusArray = parseFocusArray(org.focus);
                const geoArray = parseFocusArray(org.geo_location);
                const cityMatch = !cityFilter || org.city === cityFilter;
                const nameMatch = !searchTerm || org.name?.toLowerCase().includes(searchTerm);

                const missingFocus = focusArray.length === 0;
                const missingGeo = geoArray.length === 0;

                let matches = false;
                switch(filter) {
                    case 'both':
                        matches = missingFocus && missingGeo;
                        break;
                    case 'focus':
                        matches = missingFocus;
                        break;
                    case 'service':
                        matches = missingGeo;
                        break;
                    case 'either':
                        matches = missingFocus || missingGeo;
                        break;
                }

                return matches && cityMatch && nameMatch;
            });

            const resultsDiv = document.getElementById('qualityResults');
            const previewList = document.getElementById('qualityPreviewList');
            const matchCount = document.getElementById('qualityMatchCount');

            if (qualityMatches.length === 0) {
                matchCount.textContent = '‚úÖ No organizations found with missing data!';
                resultsDiv.style.display = 'block';
                previewList.innerHTML = '<p style="color: #059669; padding: 20px; text-align: center;">All organizations are properly categorized!</p>';
                return;
            }

            matchCount.textContent = `‚ö†Ô∏è Found ${qualityMatches.length} organizations with missing data`;

            previewList.innerHTML = `
                <div class="bulk-select-all">
                    <input type="checkbox" id="qualitySelectAll" checked onchange="toggleAllQualityMatches(this.checked)">
                    <label for="qualitySelectAll" style="cursor: pointer; font-weight: bold; color: #1e40af;">Select/Deselect All | Bulk assign above, or edit individually below</label>
                </div>
            ` + qualityMatches.map((org) => {
                const focusArray = parseFocusArray(org.focus);
                const geoArray = parseFocusArray(org.geo_location);
                const missingFocus = focusArray.length === 0;
                const missingGeo = geoArray.length === 0;

                return `
                    <div class="bulk-preview-item" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="checkbox" class="quality-checkbox" data-org-id="${org.id}" checked>
                            <div style="flex: 1;">
                                <strong>${escapeHtml(org.name)}</strong>
                                ${org.city ? `<span style="color: #64748b; font-size: 12px;"> ‚Ä¢ ${escapeHtml(org.city)}</span>` : ''}
                            </div>
                            <button class="btn btn-danger btn-small" onclick="deleteFromQuality('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                        
                        <!-- Focus Areas Section -->
                        <div style="margin-left: 30px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <label style="font-weight: 600; font-size: 13px; color: #1e293b;">Focus Areas:</label>
                                ${missingFocus ? '<span style="color: #ef4444; font-size: 12px;">‚ùå Missing</span>' : ''}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                ${focusArray.length > 0 ? focusArray.map(tag => `
                                    <span class="tag">
                                        ${escapeHtml(tag)}
                                        <span class="tag-remove" onclick="removeTagFromQuality('${org.id}', 'focus', '${escapeHtml(tag).replace(/'/g, "\\'")}')">&times;</span>
                                    </span>
                                `).join('') : '<span style="color: #9ca3af; font-size: 13px; font-style: italic;">None</span>'}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="qualityFocus_${org.id}" class="field-select" style="flex: 1; max-width: 200px; font-size: 13px; padding: 4px 8px;">
                                    <option value="">+ Add existing...</option>
                                    ${allFocusAreas.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('')}
                                </select>
                                <button class="btn btn-small btn-success" onclick="addTagFromQuality('${org.id}', 'focus', document.getElementById('qualityFocus_${org.id}').value)">Add</button>
                                <input type="text" id="qualityCustomFocus_${org.id}" placeholder="Or type new..." class="field-input" style="flex: 1; max-width: 150px; font-size: 13px; padding: 4px 8px;">
                                <button class="btn btn-small btn-success" onclick="addCustomTagFromQuality('${org.id}', 'focus', document.getElementById('qualityCustomFocus_${org.id}').value)">Add Custom</button>
                            </div>
                        </div>

                        <!-- Service Areas Section -->
                        <div style="margin-left: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <label style="font-weight: 600; font-size: 13px; color: #1e293b;">Service Areas:</label>
                                ${missingGeo ? '<span style="color: #ef4444; font-size: 12px;">‚ùå Missing</span>' : ''}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                ${geoArray.length > 0 ? geoArray.map(tag => `
                                    <span class="tag" style="background: #dbeafe; color: #1e40af;">
                                        ${escapeHtml(tag)}
                                        <span class="tag-remove" onclick="removeTagFromQuality('${org.id}', 'geo_location', '${escapeHtml(tag).replace(/'/g, "\\'")}')">&times;</span>
                                    </span>
                                `).join('') : '<span style="color: #9ca3af; font-size: 13px; font-style: italic;">None</span>'}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="qualityGeo_${org.id}" class="field-select" style="flex: 1; max-width: 200px; font-size: 13px; padding: 4px 8px;">
                                    <option value="">+ Add existing...</option>
                                    ${allGeoLocations.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('')}
                                </select>
                                <button class="btn btn-small btn-success" onclick="addTagFromQuality('${org.id}', 'geo_location', document.getElementById('qualityGeo_${org.id}').value)">Add</button>
                                <input type="text" id="qualityCustomGeo_${org.id}" placeholder="Or type new..." class="field-input" style="flex: 1; max-width: 150px; font-size: 13px; padding: 4px 8px;">
                                <button class="btn btn-small btn-success" onclick="addCustomTagFromQuality('${org.id}', 'geo_location', document.getElementById('qualityCustomGeo_${org.id}').value)">Add Custom</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.style.display = 'block';
        }

        function toggleAllQualityMatches(checked) {
            document.querySelectorAll('.quality-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        async function executeQualityAssign(field) {
            // Get value from dropdown or custom input
            let value;
            if (field === 'focus') {
                const dropdown = document.getElementById('qualityFocusSelect').value;
                value = dropdown === '__custom__' 
                    ? document.getElementById('qualityCustomFocus').value.trim()
                    : dropdown;
            } else {
                const dropdown = document.getElementById('qualityGeoSelect').value;
                value = dropdown === '__custom__' 
                    ? document.getElementById('qualityCustomGeo').value.trim()
                    : dropdown;
            }

            const fieldName = field === 'focus' ? 'focus area' : 'service area';

            if (!value) {
                showToast(`Please ${value === '__custom__' ? 'enter' : 'select'} a ${fieldName} to assign`, 'error');
                return;
            }

            const checkedIds = Array.from(document.querySelectorAll('.quality-checkbox:checked'))
                .map(cb => cb.dataset.orgId);

            const selectedOrgs = qualityMatches.filter(org => checkedIds.includes(org.id));

            if (selectedOrgs.length === 0) {
                showToast('No organizations selected', 'error');
                return;
            }

            const confirmed = confirm(`Add "${value}" to ${selectedOrgs.length} selected organizations?`);
            if (!confirmed) return;

            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;

            for (const org of selectedOrgs) {
                let array = parseFocusArray(org[field]);

                if (array.includes(value)) {
                    skipCount++;
                    continue;
                }

                array.push(value);

                try {
                    const { error } = await supabaseClient
                        .from('organizations')
                        .update({ [field]: array })
                        .eq('id', org.id);

                    if (error) {
                        console.error(`Failed to update ${org.name}:`, error);
                        errorCount++;
                        continue;
                    }

                    org[field] = array;
                    successCount++;
                } catch (error) {
                    console.error(`Failed to update ${org.name}:`, error);
                    errorCount++;
                }
            }

            if (errorCount > 0) {
                showToast(`‚ö†Ô∏è Added to ${successCount} orgs, ${skipCount} already had it, ${errorCount} failed`, 'error');
            } else {
                showToast(`‚úÖ Added "${value}" to ${successCount} organizations (${skipCount} already had it)`, 'success');
            }

            // Reset custom inputs
            document.getElementById('qualityFocusSelect').value = '';
            document.getElementById('qualityGeoSelect').value = '';
            document.getElementById('qualityCustomFocus').style.display = 'none';
            document.getElementById('qualityCustomGeo').style.display = 'none';

            // Refresh the view
            loadOrganizations();
            setTimeout(() => {
                updateQualityView();
            }, 500);
        }

        function toggleQualityCustomFocus() {
            const select = document.getElementById('qualityFocusSelect');
            const input = document.getElementById('qualityCustomFocus');
            input.style.display = select.value === '__custom__' ? 'block' : 'none';
            if (select.value === '__custom__') {
                input.focus();
            }
        }

        function toggleQualityCustomGeo() {
            const select = document.getElementById('qualityGeoSelect');
            const input = document.getElementById('qualityCustomGeo');
            input.style.display = select.value === '__custom__' ? 'block' : 'none';
            if (select.value === '__custom__') {
                input.focus();
            }
        }

        async function addTagFromQuality(orgId, field, tag) {
            if (!tag) {
                showToast('Please select a value to add', 'error');
                return;
            }

            const org = qualityMatches.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);
            
            if (array.includes(tag)) {
                showToast('This organization already has that tag', 'error');
                return;
            }

            array.push(tag);

            try {
                const { error } = await supabaseClient
                    .from('organizations')
                    .update({ [field]: array })
                    .eq('id', orgId);

                if (error) throw error;

                org[field] = array;
                
                // Update the corresponding org in main list too
                const mainOrg = organizations.find(o => o.id === orgId);
                if (mainOrg) mainOrg[field] = array;

                showToast('‚úÖ Tag added', 'success');
                updateQualityView();
            } catch (error) {
                console.error('Failed to add tag:', error);
                showToast('Failed to add tag: ' + error.message, 'error');
            }
        }

        async function addCustomTagFromQuality(orgId, field, tag) {
            tag = tag.trim();
            
            if (!tag) {
                showToast('Please enter a value', 'error');
                return;
            }

            const org = qualityMatches.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);
            
            if (array.includes(tag)) {
                showToast('This organization already has that tag', 'error');
                return;
            }

            array.push(tag);

            try {
                const { error } = await supabaseClient
                    .from('organizations')
                    .update({ [field]: array })
                    .eq('id', orgId);

                if (error) throw error;

                org[field] = array;
                
                // Update the corresponding org in main list too
                const mainOrg = organizations.find(o => o.id === orgId);
                if (mainOrg) mainOrg[field] = array;

                // Add to global lists if new
                if (field === 'focus' && !allFocusAreas.includes(tag)) {
                    allFocusAreas.push(tag);
                    allFocusAreas.sort();
                } else if (field === 'geo_location' && !allGeoLocations.includes(tag)) {
                    allGeoLocations.push(tag);
                    allGeoLocations.sort();
                }

                showToast(`‚úÖ Added "${tag}"`, 'success');
                
                // Reload to update all dropdowns
                await loadOrganizations();
                updateQualityView();
            } catch (error) {
                console.error('Failed to add tag:', error);
                showToast('Failed to add tag: ' + error.message, 'error');
            }
        }

        async function removeTagFromQuality(orgId, field, tag) {
            const org = qualityMatches.find(o => o.id === orgId);
            if (!org) return;

            let array = parseFocusArray(org[field]);
            array = array.filter(t => t !== tag);

            try {
                const { error } = await supabaseClient
                    .from('organizations')
                    .update({ [field]: array })
                    .eq('id', orgId);

                if (error) throw error;

                org[field] = array;
                
                // Update the corresponding org in main list too
                const mainOrg = organizations.find(o => o.id === orgId);
                if (mainOrg) mainOrg[field] = array;

                showToast('‚úÖ Tag removed', 'success');
                updateQualityView();
            } catch (error) {
                console.error('Failed to remove tag:', error);
                showToast('Failed to remove tag: ' + error.message, 'error');
            }
        }

        async function deleteFromQuality(id, name) {
            await deleteOrg(id, name);
            // Refresh the quality view
            updateQualityView();
        }

        function openCreateModal() {
            createGeoTags = [];
            createFocusTags = [];
            document.getElementById('createForm').reset();
            document.getElementById('createGeoTags').innerHTML = '';
            document.getElementById('createFocusTags').innerHTML = '';
            
            // Populate city dropdown
            const citySelect = document.getElementById('createCity');
            citySelect.innerHTML = '<option value="">Select a city...</option>';
            allCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // Populate geo location dropdown
            const geoSelect = document.getElementById('createGeoSelect');
            geoSelect.innerHTML = '<option value="">+ Add service area...</option>';
            allGeoLocations.forEach(geo => {
                const option = document.createElement('option');
                option.value = geo;
                option.textContent = geo;
                geoSelect.appendChild(option);
            });
            
            // Populate focus dropdown
            const focusSelect = document.getElementById('createFocusSelect');
            focusSelect.innerHTML = '<option value="">+ Add focus area...</option>';
            allFocusAreas.forEach(focus => {
                const option = document.createElement('option');
                option.value = focus;
                option.textContent = focus;
                focusSelect.appendChild(option);
            });
            
            document.getElementById('createModal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        function addCreateTag(type) {
            const selectId = type === 'geo' ? 'createGeoSelect' : 'createFocusSelect';
            const select = document.getElementById(selectId);
            const value = select.value;
            
            if (!value) return;
            
            if (type === 'geo') {
                if (!createGeoTags.includes(value)) {
                    createGeoTags.push(value);
                    renderCreateTags('geo');
                }
            } else {
                if (!createFocusTags.includes(value)) {
                    createFocusTags.push(value);
                    renderCreateTags('focus');
                }
            }
            
            select.value = '';
        }

        function removeCreateTag(type, tag) {
            if (type === 'geo') {
                createGeoTags = createGeoTags.filter(t => t !== tag);
                renderCreateTags('geo');
            } else {
                createFocusTags = createFocusTags.filter(t => t !== tag);
                renderCreateTags('focus');
            }
        }

        function renderCreateTags(type) {
            const containerId = type === 'geo' ? 'createGeoTags' : 'createFocusTags';
            const tags = type === 'geo' ? createGeoTags : createFocusTags;
            const container = document.getElementById(containerId);
            const colorClass = type === 'geo' ? 'style="background: #dbeafe; color: #1e40af;"' : '';
            
            if (tags.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = tags.map(tag => `
                <span class="tag" ${colorClass}>
                    ${escapeHtml(tag)}
                    <span class="tag-remove" onclick="removeCreateTag('${type}', '${escapeHtml(tag).replace(/'/g, "\\'")}')">√ó</span>
                </span>
            `).join('');
        }

        async function createOrganization(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('createName').value.trim();
                const city = document.getElementById('createCity').value;
                const url = document.getElementById('createUrl').value.trim();
                const mission = document.getElementById('createMission').value.trim();
                
                if (!name) {
                    showToast('Organization name is required', 'error');
                    return;
                }
                
                // Create slug from name
                const slug = name.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
                
                const newOrg = {
                    name: name,
                    slug: slug,
                    city: city || null,
                    url: url || null,
                    mission_statement_text: mission || null,
                    geo_location: createGeoTags.length > 0 ? createGeoTags : null,
                    focus: createFocusTags.length > 0 ? createFocusTags : null,
                    status: 'approved'
                };
                
                showToast('Creating organization...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('organizations')
                    .insert([newOrg])
                    .select();
                
                if (error) throw error;
                
                showToast('‚úÖ Organization created successfully!', 'success');
                closeCreateModal();
                loadOrganizations();
            } catch (error) {
                console.error('Create error:', error);
                showToast('Failed to create organization: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
